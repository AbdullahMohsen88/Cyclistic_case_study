ggplot(all_trips_v2, aes(x = user_type, fill = user_type)) +
geom_bar(width = 0.7, alpha = 0.9) +
geom_label(
stat = "count",
aes(label = scales::comma(after_stat(count))),
vjust = -0.5,
size = 3.8,
fill = "white",
linewidth = 0.25,
label.padding = unit(0.15, "lines")) +
facet_wrap(~ year) +
scale_y_continuous(
labels = scales::comma,
expand = expansion(mult = c(0, 0.18))) +
scale_fill_brewer(palette = "Set2") +
labs(
title = "Number of Trips by Customer Type",
subtitle = "Total trips per customer type (2019 vs 2020)",
x = "Customer Type",
y = "Number of Trips",
caption = "Source: Divvy bikes Jan 2019 to Mar 2019 and Jan 2020 to Mar 2020") +
theme_minimal(base_size = 12) +
theme(
legend.position = "none",
plot.subtitle = element_text(color = "gray40"),
plot.caption = element_text(hjust = 0),
panel.grid.minor = element_blank(),
panel.border = element_rect(color = "gray80", fill = NA, linewidth = 0.5))
ggplot(all_trips_v2, aes(x = user_type, fill = user_type)) +
geom_bar(width = 0.7, alpha = 0.9) +
geom_label(
stat = "count",
aes(label = scales::comma(after_stat(count))),
vjust = -0.5,
size = 3.8,
fill = "white",
linewidth = 0.25,
label.padding = unit(0.15, "lines")) +
facet_wrap(~ year) +
scale_y_continuous(
labels = scales::comma,
expand = expansion(mult = c(0, 0.18))) +
scale_fill_brewer(palette = "Set2") +
labs(
title = "Number of Trips by Customer Type",
subtitle = "Total trips per customer type (2019 vs 2020)",
x = "Customer Type",
y = "Number of Trips",
caption = "Source: Divvy bikes Jan 2019 to Mar 2019 and Jan 2020 to Mar 2020") +
theme_minimal(base_size = 12) +
theme(
legend.position = "none",
plot.subtitle = element_text(color = "gray40"),
plot.caption = element_text(hjust = 0),
panel.grid.minor = element_blank(),
panel.border = element_rect(color = "gray80", fill = NA, linewidth = 0.5))
library(ggplot2)
################################# Environments #################################
# Setting up my environment
library(tidyverse)
library(dplyr)
library(lubridate)
library(kableExtra)
library(ggplot2)
library(hms)
library(scales)
library(readr)
install.packages("rmarkdown")
install.packages("rmarkdown")
# Setting the file path and reading the data
setwd("~/R/Case_Studies/Cyclistic/01_Data/Raw")
trips_2019 <- read.csv("Divvy_Trips_2019_Q1.csv")
trips_2020 <- read.csv("Divvy_Trips_2020_Q1.csv")
# Selecting relevant columns and removing NA records
trips_2019_v2 <- trips_2019 %>%
select(trip_id,from_station_id,from_station_name,start_time,to_station_id,
to_station_name,end_time,usertype) %>%
na.omit()
# Selecting relevant columns and removing NA records
trips_2019_v2 <- trips_2019 %>%
select(trip_id,from_station_id,from_station_name,start_time,to_station_id,
to_station_name,end_time,usertype) %>%
na.omit()
################################# Environments #################################
# Setting up my environment
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)
library(hms)
library(scales)
# Selecting relevant columns and removing NA records
trips_2019_v2 <- trips_2019 %>%
select(trip_id,from_station_id,from_station_name,start_time,to_station_id,
to_station_name,end_time,usertype) %>%
na.omit()
trips_2020_v2 <- trips_2020 %>%
select(ride_id,start_station_id,start_station_name,started_at,end_station_id,
end_station_name,ended_at,member_casual) %>%
na.omit()
clean_and_add_duration <- function(df,
start_col, end_col,
station_from_col, station_to_col,
user_col) {
df %>%
mutate(
id = row_number(),
start_at = ymd_hms({{ start_col }}),
end_at   = ymd_hms({{ end_col }}),
year  = year(start_at),
month = month(start_at, label = TRUE, abbr = TRUE),
day   = wday(start_at, label = TRUE, abbr = TRUE),
# Keep characterible string version for display
start_time = format(start_at, "%H:%M:%S"),
end_time   = format(end_at,   "%H:%M:%S"),
start_station_name = {{ station_from_col }},
end_station_name   = {{ station_to_col }},
user_type          = {{ user_col }},
# === Extract hms directly from POSIXct ===
start_hms = as_hms(start_at),
end_hms   = as_hms(end_at),
trip_seconds = case_when(
end_hms >= start_hms ~ as.numeric(end_hms - start_hms),
end_hms <  start_hms ~ as.numeric(end_hms - start_hms) + 24 * 3600
),
trip_length = as_hms(trip_seconds)
) %>%
select(
id, start_station_name, start_at, start_time,
year, month, day, user_type,
end_station_name, end_at, end_time,
trip_length, trip_seconds
)
}
# 2019
trips_2019_v3 <- clean_and_add_duration(
trips_2019_v2,
start_time,
end_time,
from_station_name,
to_station_name,
usertype
)
# 2020
trips_2020_v3 <- clean_and_add_duration(
trips_2020_v2,
started_at,
ended_at,
start_station_name,
end_station_name,
member_casual
)
# binding the data and checking for duplicates
all_trips <- bind_rows(trips_2019_v3,trips_2020_v3)
# Unifying the values in user_type
all_trips$user_type <- ifelse(all_trips$user_type %in% c('Subscriber','member'),
'Annual member', 'Casual rider')
# removing special characters from the station names
all_trips_v2 <- all_trips %>%
mutate(start_station_name = gsub("[^[:alnum:]& ]", "", all_trips$start_station_name),
end_station_name = gsub("[^[:alnum:]& ]", "", all_trips$end_station_name))
ggplot(all_trips_v2, aes(x = user_type, fill = user_type)) +
geom_bar(width = 0.7, alpha = 0.9) +
geom_label(
stat = "count",
aes(label = scales::comma(after_stat(count))),
vjust = -0.5,
size = 3.8,
fill = "white",
linewidth = 0.25,
label.padding = unit(0.15, "lines")) +
facet_wrap(~ year) +
scale_y_continuous(
labels = scales::comma,
expand = expansion(mult = c(0, 0.18))) +
scale_fill_brewer(palette = "Set2") +
labs(
title = "Number of Trips by Customer Type",
subtitle = "Total trips per customer type (2019 vs 2020)",
x = "Customer Type",
y = "Number of Trips",
caption = "Source: Divvy bikes Jan 2019 to Mar 2019 and Jan 2020 to Mar 2020") +
theme_minimal(base_size = 12) +
theme(
legend.position = "none",
plot.subtitle = element_text(color = "gray40"),
plot.caption = element_text(hjust = 0),
panel.grid.minor = element_blank(),
panel.border = element_rect(color = "gray80", fill = NA, linewidth = 0.5))
avg_trip_summ <- all_trips_v2 %>%
group_by(year, user_type) %>%
summarise(
n_trips  = n(),
avg_duration_min  = round(mean(trip_seconds / 60), 2),
.groups = "drop")
ggplot(avg_trip_summ, aes(x = user_type, y = avg_duration_min,
fill = user_type)) +
geom_col(width = 0.7) +
geom_label(
aes(label = paste(avg_duration_min, "min")),
vjust = -0.5,
size = 3.3,
fill = "white",
linewidth = 0.25,
label.padding = unit(0.15, "lines"))+  facet_wrap(~ year) +
#scale_y_continuous(breaks = seq(0, 60, 10)) +
labs(
title = "Average Trip Duration for Customer Types",
subtitle = "Comparison of average duration (2019 vs 2020)",
x = "Customer Type",
y = "Average Duration (minutes)",
caption = "Source: Divvy bikes Jan 2019 to Mar 2019 and Jan 2020 to Mar 2020") +
scale_fill_brewer(palette = "Set2") +
ylim(0,50)+
theme_minimal() +
guides(fill = "none") +
theme(plot.subtitle = element_text(color = "gray40"),
legend.position = "top",
plot.caption = element_text(hjust = 0),
panel.border = element_rect(color = "gray80", fill = NA, linewidth = 0.5))
avg_weekly_summ_user <- all_trips_v2 %>%
group_by(year, user_type, day) %>%
summarise(
n_trips  = n(),
avg_duration_min  = round(mean(trip_seconds / 60), 2),
.groups = "drop") %>%
mutate(
day = factor(day, levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")))
ggplot(avg_weekly_summ_user, aes(x = day, y = n_trips,
color = user_type,
group = user_type)) +
geom_smooth(se = FALSE, linewidth = 1, span = 0.6) +
geom_point(size = 2, shape = 21, fill = "white", stroke = 1.5) +
scale_y_continuous(
labels = comma,
limits = c(0, 80000),
expand = expansion(mult = c(0, 0.1))) +
scale_color_brewer(palette = "Set2") +
labs(
title = "Weekly Trips Summary by Customer Type",
subtitle = "Weekly patterns",
x = "Day of Week",
y = "Number of Trips",
caption = "Source: Divvy bikes Jan 2019 to Mar 2019 and Jan 2020 to Mar 2020",
color = "Customer Type") +
theme_minimal(base_size = 13) +
theme(
plot.subtitle = element_text(color = "gray40"),
legend.position = "top",
plot.caption = element_text(hjust = 0),
panel.grid.minor = element_blank(),
panel.border = element_rect(color = "gray80", fill = NA, linewidth = 0.5))
avg_weekly_casual <- all_trips_v2 %>%
filter(user_type == "Casual rider") %>%
group_by(day) %>%
summarise(
n_trips  = n(),
avg_duration_min  = round(mean(trip_seconds / 60), 2), # Minutes, 2 decimals
.groups = "drop") %>%
mutate(
day = factor(day, levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")))
ggplot(avg_weekly_casual, aes(y = avg_duration_min,
x = day, fill = day)) +
geom_col(width = 0.7) +
geom_label(
aes(label = paste(avg_duration_min, "min")),
vjust = -0.5,
size = 3.3,
fill = "white",
linewidth = 0.25,
label.padding = unit(0.15, "lines"))+
labs(
x = "Day of week",
y = "Average duration (minutes)",
title = "Average Trip Duration by Day",
subtitle = "Average trip duration for Casual rider by day",
caption = "Source: Divvy bikes Jan 2019 to Mar 2019 and Jan 2020 to Mar 2020") +
scale_fill_brewer(palette = "Set2") +
ylim(0,60) +
theme_minimal() +
theme(plot.subtitle = element_text(color = "gray40"),
legend.position = "none",
plot.caption = element_text(hjust = 0),
panel.border = element_rect(color = "gray80", fill = NA, linewidth = 0.5))
trips_binned <- all_trips_v2 %>%
filter(user_type == "Casual rider") %>%
mutate(
time_bin = floor_date(start_at, "1 hour"),
time_of_day = as_hms(time_bin)) %>%
count(time_of_day, name = "n") %>%
complete(time_of_day = hms(seq(0, 23*3600, 3600)), fill = list(n = 0))
peak_hour <- trips_binned %>%
slice_max(n, n = 1) %>%
mutate(
peak_label = paste0(format(time_of_day, "%H:%M"), "\n",
scales::comma(n), " trips"))
ggplot(trips_binned, aes(x = time_of_day, y = n)) +
geom_col(fill = "#42A5F5", width = 3400, alpha = 0.92) +  # ~1-hour width
geom_label(
data = peak_hour,
aes(label = peak_label),
vjust = -0.5,
size = 3.3,
fill = "white",
linewidth = 0.3,
label.padding = unit(0.25, "lines")) +
scale_x_time(
labels = time_format("%H:%M"),
breaks = hms(hours = 0:23),
expand = expansion(mult = c(0.01, 0.01))) +
#scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.18))) +
ylim(0,10000) +
labs(
title = "Busiest Hours of Day",
subtitle = "Peak hours for Casual rider",
x = "Start Time (24h)",
y = "Number of Trips",
caption = "Source: Divvy bikes Jan 2019 to Mar 2019 and Jan 2020 to Mar 2020") +
theme_minimal(base_size = 13) +
theme(
plot.subtitle = element_text(color = "gray50"),
panel.grid.minor = element_blank(),
plot.caption = element_text(hjust = 0),
axis.text.x = element_text(angle = 0))
